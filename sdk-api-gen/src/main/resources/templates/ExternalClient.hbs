{{#if packageName}}package {{packageName}};{{/if}}

import dev.restate.sdk.common.StateKey;
import dev.restate.sdk.common.Serde;
import dev.restate.sdk.dynrpc.CodegenUtils;
import io.grpc.Channel;
import java.util.Optional;

public class {{className}}ExternalClient {

    private static final String SERVICE_NAME = "{{fqcn}}";

    {{#methods}}
    private static final io.grpc.MethodDescriptor<dev.restate.sdk.dynrpc.generated.{{#if isObject}}KeyedRpcRequest{{else}}RpcRequest{{/if}}, dev.restate.sdk.dynrpc.generated.RpcResponse> {{descFieldName}} = CodegenUtils.generateMethodDescriptor(dev.restate.sdk.dynrpc.template.generated.{{#if isObject}}KeyedServiceGrpc{{else}}ServiceGrpc{{/if}}.getTemplateMethod(), SERVICE_NAME, "{{name}}");
    {{^inputEmpty}}private static final Serde<{{{inputFqcn}}}> {{inputSerdeFieldName}} = {{{inputSerdeDecl}}};{{/inputEmpty}}
    {{^outputEmpty}}private static final Serde<{{{outputFqcn}}}> {{outputSerdeFieldName}} = {{{outputSerdeDecl}}};{{/outputEmpty}}
    {{/methods}}

    private final Channel restateChannel;
    {{#isObject}}private final String key;{{/isObject}}

    public {{className}}ExternalClient(Channel restateChannel{{#isObject}}, String key{{/isObject}}) {
        this.restateChannel = restateChannel;
        {{#isObject}}this.key = key;{{/isObject}}
    }

    {{#methods}}
    public {{#if outputEmpty}}void{{else}}{{{outputFqcn}}}{{/if}} {{name}}({{^inputEmpty}}{{{inputFqcn}}} req{{/inputEmpty}}) {
        com.google.protobuf.Value response = CodegenUtils.ExternalClient.{{#if isObject}}invokeKeyed{{else}}invoke{{/if}}(this.restateChannel, {{descFieldName}}{{#isObject}}, this.key{{/isObject}}, {{#if inputEmpty}}null{{else}}CodegenUtils.tToValue({{inputSerdeFieldName}}, req){{/if}});
        {{^outputEmpty}}
        return CodegenUtils.valueToT({{outputSerdeFieldName}}, response);
        {{/outputEmpty}}
    }
    {{/methods}}

    public {{className}}OneWayExternalClient oneWay() {
        return new {{className}}OneWayExternalClient();
    }

    public class {{className}}OneWayExternalClient {

        {{#methods}}
        public void {{name}}({{^inputEmpty}}{{{inputFqcn}}} req{{/inputEmpty}}) {
            CodegenUtils.ExternalClient.{{#if isObject}}invokeKeyed{{else}}invoke{{/if}}OneWay({{../className}}ExternalClient.this.restateChannel, {{descFieldName}}{{#isObject}}, {{../className}}ExternalClient.this.key{{/isObject}}, {{#if inputEmpty}}null{{else}}CodegenUtils.tToValue({{inputSerdeFieldName}}, req){{/if}});
        }
        {{/methods}}

    }
}