{{#if packageName}}package {{packageName}};{{/if}}

import dev.restate.sdk.common.StateKey;
import dev.restate.sdk.common.Serde;
import dev.restate.sdk.workflow.impl.WorkflowCodegenUtil;
import io.grpc.Channel;
import java.util.Optional;

public class {{className}}ExternalClient {

    private static final String WORKFLOW_NAME = "{{fqcn}}";
    private static final io.grpc.MethodDescriptor<dev.restate.sdk.workflow.generated.StateRequest, dev.restate.sdk.workflow.generated.GetStateResponse> WF_MANAGER_GET_STATE_METHOD_DESC = WorkflowCodegenUtil.generateMethodDescriptorForWorkflowManager(dev.restate.sdk.workflow.template.generated.WorkflowManagerGrpc.getGetStateMethod(), WORKFLOW_NAME);
    private static final io.grpc.MethodDescriptor<dev.restate.sdk.workflow.generated.OutputRequest, dev.restate.sdk.workflow.generated.GetOutputResponse> WF_MANAGER_GET_OUTPUT_METHOD_DESC = WorkflowCodegenUtil.generateMethodDescriptorForWorkflowManager(dev.restate.sdk.workflow.template.generated.WorkflowManagerGrpc.getGetOutputMethod(), WORKFLOW_NAME);
    private static final io.grpc.MethodDescriptor<dev.restate.sdk.workflow.generated.InvokeRequest, dev.restate.sdk.workflow.generated.SubmitResponse> WF_SUBMIT_METHOD_DESC = WorkflowCodegenUtil.generateMethodDescriptorForWorkflowSubmit(WORKFLOW_NAME);

    {{#methods}}
    private static final io.grpc.MethodDescriptor<dev.restate.sdk.workflow.generated.InvokeRequest, com.google.protobuf.Value> {{descFieldName}} = WorkflowCodegenUtil.generateMethodDescriptorForWorkflow(dev.restate.sdk.workflow.template.generated.WorkflowGrpc.getInvokeTemplateMethod(), WORKFLOW_NAME, "{{name}}");
    {{^inputEmpty}}private static final Serde<{{{inputFqcn}}}> {{inputSerdeFieldName}} = {{{inputSerdeDecl}}};{{/inputEmpty}}
    {{^outputEmpty}}private static final Serde<{{{outputFqcn}}}> {{outputSerdeFieldName}} = {{{outputSerdeDecl}}};{{/outputEmpty}}
    {{/methods}}

    private final Channel restateChannel;
    private final String workflowKey;

    public {{className}}ExternalClient(Channel restateChannel, String workflowKey) {
        this.restateChannel = restateChannel;
        this.workflowKey = workflowKey;
    }

    {{#methods}}{{#if isWorkflow}}
    public dev.restate.sdk.workflow.generated.WorkflowExecutionState submit({{^inputEmpty}}{{{inputFqcn}}} req{{/inputEmpty}}) {
        return WorkflowCodegenUtil.ExternalClient.submit(restateChannel, WF_SUBMIT_METHOD_DESC, workflowKey, {{#if inputEmpty}}null{{else}}WorkflowCodegenUtil.tToValue({{inputSerdeFieldName}}, req){{/if}});
    }

    public boolean isCompleted() {
        return WorkflowCodegenUtil.ExternalClient.isCompleted(restateChannel, WF_MANAGER_GET_OUTPUT_METHOD_DESC, workflowKey);
    }

    {{^outputEmpty}}
    public Optional<{{{outputFqcn}}}> getOutput() {
        return WorkflowCodegenUtil.ExternalClient.getOutput(restateChannel, WF_MANAGER_GET_OUTPUT_METHOD_DESC, workflowKey, {{outputSerdeFieldName}});
    }{{/outputEmpty}}
    {{/if}}{{/methods}}

    public <T> Optional<T> getState(StateKey<T> key) {
        return WorkflowCodegenUtil.ExternalClient.getState(restateChannel, WF_MANAGER_GET_STATE_METHOD_DESC, workflowKey, key);
    }

    {{#methods}}{{#if isShared}}
    public {{#if outputEmpty}}void{{else}}{{{outputFqcn}}}{{/if}} {{name}}({{^inputEmpty}}{{{inputFqcn}}} req{{/inputEmpty}}) {
        com.google.protobuf.Value response = WorkflowCodegenUtil.ExternalClient.invokeShared(restateChannel, {{descFieldName}}, workflowKey, {{#if inputEmpty}}null{{else}}WorkflowCodegenUtil.tToValue({{inputSerdeFieldName}}, req){{/if}});
        {{^outputEmpty}}
        return WorkflowCodegenUtil.valueToT({{outputSerdeFieldName}}, response);
        {{/outputEmpty}}
    }
    {{/if}}{{/methods}}

    public {{className}}OneWayExternalClient oneWay() {
        return new {{className}}OneWayExternalClient();
    }

    public class {{className}}OneWayExternalClient {

        {{#methods}}{{#if isShared}}
        public void {{name}}({{^inputEmpty}}{{{inputFqcn}}} req{{/inputEmpty}}) {
            WorkflowCodegenUtil.ExternalClient.invokeSharedOneWay(restateChannel, {{descFieldName}}, workflowKey, {{#if inputEmpty}}null{{else}}WorkflowCodegenUtil.tToValue({{inputSerdeFieldName}}, req){{/if}});
        }
        {{/if}}{{/methods}}

    }
}